import React, { useMemo, useState } from "react";
import { motion, AnimatePresence } from "framer-motion";
import {
  Calendar,
  MapPin,
  Users,
  Baby,
  Wallet,
  CheckCircle2,
  ClipboardList,
  TrainFront,
  Utensils,
  Home,
  Shield,
  Sun,
  CloudRain,
  Timer,
  Search,
  Link as LinkIcon,
} from "lucide-react";

/**
 * 小雄雄的上海之旅｜行程APP（單檔 React 元件）
 * - 期間：2/5–2/10
 * - 城市：上海、寧波
 * - 成員：爸爸、媽媽、5歲小男孩
 *
 * 使用方式：把這個檔案當作 App.jsx 或 page.jsx 的預設匯出即可。
 */

const trip = {
  title: "小雄雄的上海之旅",
  dateRange: "2/5 – 2/10",
  cities: ["上海", "寧波"],
  members: ["爸爸", "媽媽", "5歲小男孩"],
  notes: [
    "以親子節奏為主：上午景點、午睡/休息、傍晚輕鬆散步。",
    "移動日盡量保留彈性；餐廳以不用排太久隊、好推車/好帶小孩為優先。",
    "每天安排 1 個主要景點 + 1 個備案即可，避免行程過滿。",
  ],
};

// 行程資料：可依需求修改
const itinerary = [
  {
    id: "d1",
    date: "2/5（四）",
    city: "上海",
    theme: "抵達日・緩慢上線",
    blocks: [
      {
        time: "上午/中午",
        icon: TrainFront,
        title: "抵達上海 → 入住/寄放行李",
        details: [
          "優先處理：SIM/eSIM、交通卡/支付、飲用水與零食補給。",
          "小孩容易暈車/累：先把午睡/休息安排好。",
        ],
      },
      {
        time: "下午",
        icon: Sun,
        title: "南京東路 & 外灘（輕鬆散步）",
        details: [
          "以走走看看為主，別硬排購物點。",
          "傍晚風大：帶薄外套。",
        ],
        links: [
          {
            label: "外灘地圖",
            href: "https://www.google.com/maps/search/?api=1&query=The%20Bund%20Shanghai",
          },
          {
            label: "南京東路地圖",
            href: "https://www.google.com/maps/search/?api=1&query=Nanjing%20Road%20Shanghai",
          },
        ],
      },
      {
        time: "晚餐",
        icon: Utensils,
        title: "親子友善餐廳（就近）",
        details: [
          "優先：距離住宿近、可訂位/翻桌快、兒童椅。",
          "備案：商場美食街（選擇多、上廁所方便）。",
        ],
      },
    ],
    kidTips: [
      "抵達日先把『小雄雄狀態』顧好：喝水、點心、上廁所、早點回房間。",
      "如果精神還不錯，再去外灘；累就直接附近商場晃晃。",
    ],
    checklist: [
      "入境/交通/付款 setup",
      "水與零食",
      "隔天行程確認（天氣/票務）",
    ],
  },
  {
    id: "d2",
    date: "2/6（五）",
    city: "上海",
    theme: "經典上海・親子版",
    blocks: [
      {
        time: "上午",
        icon: MapPin,
        title: "豫園 & 城隍廟周邊",
        details: [
          "早點到避開人潮；推車在人多處可能不太好走。",
          "想買伴手禮可在這天完成一部分。",
        ],
        links: [
          {
            label: "豫園地圖",
            href: "https://www.google.com/maps/search/?api=1&query=Yuyuan%20Garden%20Shanghai",
          },
        ],
      },
      {
        time: "中午",
        icon: Timer,
        title: "午餐 + 午睡/回飯店休息",
        details: [
          "小孩午睡是續航關鍵：建議回飯店或安排車程小睡。",
        ],
      },
      {
        time: "下午",
        icon: Home,
        title: "新天地（咖啡/甜點/散步）",
        details: [
          "節奏放慢：走走拍拍照、找間甜點店補能量。",
          "如果天氣不佳，改商場室內活動。",
        ],
        links: [
          {
            label: "新天地地圖",
            href: "https://www.google.com/maps/search/?api=1&query=Xintiandi%20Shanghai",
          },
        ],
      },
    ],
    kidTips: [
      "豫園人多時，手牽緊；可以準備一個『小任務』：找龍、找魚、找紅燈籠。",
      "下午以舒服為主，不追景點數量。",
    ],
    checklist: [
      "豫園/新天地交通",
      "午睡安排",
      "備用雨具",
    ],
  },
  {
    id: "d3",
    date: "2/7（六）",
    city: "上海",
    theme: "親子大本營（樂園/室內備案）",
    blocks: [
      {
        time: "全天（主計畫）",
        icon: Baby,
        title: "上海迪士尼（或大型親子館）",
        details: [
          "如果要去迪士尼：建議先決定『必玩 3 項』，其餘看體力。",
          "不去也沒關係：可改大型室內親子館/科技館/水族館類型。",
        ],
        links: [
          {
            label: "上海迪士尼地圖",
            href: "https://www.google.com/maps/search/?api=1&query=Shanghai%20Disneyland%20Park",
          },
        ],
      },
      {
        time: "晚餐",
        icon: Utensils,
        title: "回住宿附近吃（讓大人也放鬆）",
        details: [
          "樂園日通常很累：晚餐選離家近、好坐的。",
        ],
      },
    ],
    kidTips: [
      "帶推車/雨衣/替換衣物；小孩最常在排隊時崩潰，準備小玩具或貼紙書。",
      "每 2–3 小時安排一次『補給站』：水、點心、上廁所。",
    ],
    checklist: [
      "票券/預約（如需要）",
      "推車/雨具/替換衣",
      "行動電源",
    ],
  },
  {
    id: "d4",
    date: "2/8（日）",
    city: "寧波",
    theme: "移動日・換城市",
    blocks: [
      {
        time: "上午",
        icon: TrainFront,
        title: "上海 → 寧波（高鐵/交通）",
        details: [
          "建議選小孩容易小睡的車次；上車前先上廁所。",
          "行李先簡化：隨身包放尿布/濕紙巾/備用衣物（如需要）。",
        ],
      },
      {
        time: "下午",
        icon: MapPin,
        title: "天一廣場/老外灘（輕鬆走）",
        details: [
          "寧波步調較慢：移動日不排硬景點。",
        ],
        links: [
          {
            label: "天一廣場地圖",
            href: "https://www.google.com/maps/search/?api=1&query=Tianyi%20Square%20Ningbo",
          },
          {
            label: "寧波老外灘地圖",
            href: "https://www.google.com/maps/search/?api=1&query=Ningbo%20Old%20Bund",
          },
        ],
      },
    ],
    kidTips: [
      "移動日的 KPI：準時抵達、平安吃到飯、早點洗澡睡覺。",
      "景點只是加分，不是必須。",
    ],
    checklist: [
      "車票/證件",
      "隨身補給包",
      "住宿入住資訊",
    ],
  },
  {
    id: "d5",
    date: "2/9（一）",
    city: "寧波",
    theme: "文化 + 放電（兩段式）",
    blocks: [
      {
        time: "上午",
        icon: MapPin,
        title: "天一閣（文化輕旅行）",
        details: [
          "走慢一點、挑重點看；小孩不耐久站可縮短停留。",
        ],
        links: [
          {
            label: "天一閣地圖",
            href: "https://www.google.com/maps/search/?api=1&query=Tianyi%20Pavilion%20Museum%20Ningbo",
          },
        ],
      },
      {
        time: "下午",
        icon: Baby,
        title: "公園/室內遊戲區（放電）",
        details: [
          "視天氣：戶外公園或室內遊戲區二擇一。",
          "讓小孩跑夠，晚上大人比較好休息。",
        ],
      },
    ],
    kidTips: [
      "文化景點採『短、快、好』：20–40 分鐘一段，搭配小休息。",
    ],
    checklist: [
      "門票/開放時間（如需要）",
      "雨天備案（室內遊戲區/商場）",
    ],
  },
  {
    id: "d6",
    date: "2/10（二）",
    city: "上海/返程",
    theme: "回程日・收尾",
    blocks: [
      {
        time: "上午",
        icon: ClipboardList,
        title: "退房/整理行李",
        details: [
          "把『最常用』放最上層：外套、濕紙巾、點心、水。",
        ],
      },
      {
        time: "中午/下午",
        icon: TrainFront,
        title: "寧波 → 上海/機場（依返程安排）",
        details: [
          "預留比想像多 30–60 分鐘的機動時間。",
        ],
      },
      {
        time: "備案",
        icon: CloudRain,
        title: "若有空檔：附近商場/咖啡店等候",
        details: [
          "回程日不塞景點，確保順利返程最重要。",
        ],
      },
    ],
    kidTips: [
      "回程日小孩情緒波動正常：帶熟悉的小玩具/零食，並把時間拉鬆。",
    ],
    checklist: [
      "證件/票券",
      "充電與行動電源",
      "伴手禮與液體規範檢查（若搭飛機）",
    ],
  },
];

const packing = {
  essentials: [
    "護照/證件/票券（紙本 + 電子備份）",
    "手機/充電器/行動電源/轉接頭",
    "支付工具（信用卡/行動支付/現金少量）",
    "常用藥品（退燒、腸胃、過敏、OK 繃）",
  ],
  kid: [
    "替換衣物 1–2 套（隨身）",
    "濕紙巾/面紙/小垃圾袋",
    "小點心/水壺",
    "貼紙書/小玩具（排隊救星）",
    "推車（可選）",
  ],
  weather: [
    "薄外套/防風外套",
    "雨具（摺疊傘/雨衣）",
    "舒服好走的鞋",
  ],
};

const budgetTemplate = [
  { k: "交通", v: 0, hint: "高鐵/地鐵/計程車" },
  { k: "住宿", v: 0, hint: "上海 + 寧波" },
  { k: "餐飲", v: 0, hint: "含點心與飲料" },
  { k: "門票", v: 0, hint: "樂園/博物館" },
  { k: "購物", v: 0, hint: "伴手禮/紀念品" },
];

function cnMoney(n) {
  try {
    return new Intl.NumberFormat("zh-Hant-TW", {
      style: "currency",
      currency: "TWD",
      maximumFractionDigits: 0,
    }).format(n || 0);
  } catch {
    return String(n || 0);
  }
}

function classNames(...xs) {
  return xs.filter(Boolean).join(" ");
}

function IconBadge({ icon: Icon, label }) {
  return (
    <div className="inline-flex items-center gap-2 rounded-2xl border px-3 py-1 text-sm shadow-sm">
      <Icon className="h-4 w-4" />
      <span className="leading-none">{label}</span>
    </div>
  );
}

function ExternalLink({ href, children }) {
  return (
    <a
      href={href}
      target="_blank"
      rel="noreferrer"
      className="inline-flex items-center gap-2 rounded-xl border px-3 py-2 text-sm hover:shadow-sm"
    >
      <LinkIcon className="h-4 w-4" />
      <span>{children}</span>
    </a>
  );
}

function SectionCard({ title, icon: Icon, children, right }) {
  return (
    <div className="rounded-2xl border bg-white/80 p-4 shadow-sm backdrop-blur">
      <div className="mb-3 flex items-start justify-between gap-3">
        <div className="flex items-center gap-2">
          {Icon ? <Icon className="h-5 w-5" /> : null}
          <h3 className="text-base font-semibold">{title}</h3>
        </div>
        {right}
      </div>
      {children}
    </div>
  );
}

function Pill({ active, onClick, children }) {
  return (
    <button
      onClick={onClick}
      className={classNames(
        "rounded-2xl border px-4 py-2 text-sm shadow-sm transition",
        active ? "bg-black text-white" : "bg-white hover:shadow"
      )}
      type="button"
    >
      {children}
    </button>
  );
}

function List({ items }) {
  return (
    <ul className="space-y-2">
      {items.map((t, i) => (
        <li key={i} className="flex gap-2">
          <CheckCircle2 className="mt-0.5 h-4 w-4 shrink-0" />
          <span className="text-sm leading-relaxed text-slate-700">{t}</span>
        </li>
      ))}
    </ul>
  );
}

function DayBlock({ b }) {
  const I = b.icon || MapPin;
  return (
    <div className="rounded-2xl border bg-white p-4 shadow-sm">
      <div className="flex items-start justify-between gap-3">
        <div className="flex items-start gap-3">
          <div className="rounded-2xl border p-2">
            <I className="h-5 w-5" />
          </div>
          <div>
            <div className="text-xs text-slate-500">{b.time}</div>
            <div className="text-base font-semibold">{b.title}</div>
          </div>
        </div>
      </div>
      {b.details?.length ? (
        <div className="mt-3">
          <List items={b.details} />
        </div>
      ) : null}
      {b.links?.length ? (
        <div className="mt-3 flex flex-wrap gap-2">
          {b.links.map((l) => (
            <ExternalLink key={l.href} href={l.href}>
              {l.label}
            </ExternalLink>
          ))}
        </div>
      ) : null}
    </div>
  );
}

export default function TripItineraryApp() {
  const [activeDayId, setActiveDayId] = useState(itinerary[0]?.id);
  const [query, setQuery] = useState("");
  const [budget, setBudget] = useState(() => {
    const obj = {};
    for (const r of budgetTemplate) obj[r.k] = r.v;
    return obj;
  });
  const [done, setDone] = useState(() => {
    const obj = {};
    for (const d of itinerary) {
      obj[d.id] = {};
      for (const c of d.checklist || []) obj[d.id][c] = false;
    }
    return obj;
  });

  const activeDay = useMemo(
    () => itinerary.find((d) => d.id === activeDayId) || itinerary[0],
    [activeDayId]
  );

  const filteredDays = useMemo(() => {
    const q = query.trim();
    if (!q) return itinerary;
    return itinerary.filter((d) => {
      const hay = [d.date, d.city, d.theme, ...(d.blocks || []).map((b) => b.title)].join(" ");
      return hay.toLowerCase().includes(q.toLowerCase());
    });
  }, [query]);

  const budgetSum = useMemo(() => {
    let s = 0;
    for (const k of Object.keys(budget)) s += Number(budget[k] || 0);
    return s;
  }, [budget]);

  function toggleChecklist(dayId, item) {
    setDone((prev) => ({
      ...prev,
      [dayId]: {
        ...(prev[dayId] || {}),
        [item]: !(prev[dayId]?.[item] ?? false),
      },
    }));
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 via-white to-slate-100">
      <div className="mx-auto max-w-6xl p-4 md:p-8">
        {/* Header */}
        <div className="rounded-3xl border bg-white/70 p-5 shadow-sm backdrop-blur md:p-7">
          <div className="flex flex-col gap-4 md:flex-row md:items-start md:justify-between">
            <div>
              <h1 className="text-2xl font-semibold tracking-tight md:text-3xl">{trip.title}</h1>
              <div className="mt-2 flex flex-wrap gap-2">
                <IconBadge icon={Calendar} label={trip.dateRange} />
                <IconBadge icon={MapPin} label={trip.cities.join(" / ")} />
                <IconBadge icon={Users} label={trip.members.join("、")} />
              </div>
              <div className="mt-4 space-y-2 text-sm text-slate-700">
                {trip.notes.map((n, i) => (
                  <div key={i} className="flex gap-2">
                    <Shield className="mt-0.5 h-4 w-4 shrink-0" />
                    <span className="leading-relaxed">{n}</span>
                  </div>
                ))}
              </div>
            </div>

            <div className="w-full md:w-[320px]">
              <div className="rounded-2xl border bg-white p-4 shadow-sm">
                <div className="flex items-center gap-2">
                  <Search className="h-4 w-4" />
                  <div className="text-sm font-semibold">快速搜尋行程</div>
                </div>
                <input
                  value={query}
                  onChange={(e) => setQuery(e.target.value)}
                  placeholder="輸入：外灘 / 迪士尼 / 天一閣…"
                  className="mt-3 w-full rounded-2xl border px-4 py-3 text-sm outline-none focus:ring-2"
                />
                <div className="mt-3 text-xs text-slate-500">
                  會同步篩選左側日期清單，方便快速跳到目標。
                </div>
              </div>
            </div>
          </div>
        </div>

        <div className="mt-6 grid gap-6 md:grid-cols-[320px,1fr]">
          {/* Sidebar: days */}
          <div className="space-y-4">
            <SectionCard
              title="日期清單"
              icon={Calendar}
              right={
                <span className="text-xs text-slate-500">共 {filteredDays.length} 天</span>
              }
            >
              <div className="flex flex-wrap gap-2">
                {filteredDays.map((d) => (
                  <Pill
                    key={d.id}
                    active={d.id === activeDayId}
                    onClick={() => setActiveDayId(d.id)}
                  >
                    <div className="flex flex-col items-start">
                      <span className="text-xs opacity-80">{d.city}</span>
                      <span className="font-medium">{d.date}</span>
                    </div>
                  </Pill>
                ))}
              </div>
            </SectionCard>

            <SectionCard title="行李清單" icon={ClipboardList}>
              <div className="grid gap-4">
                <div>
                  <div className="text-sm font-semibold">必備</div>
                  <div className="mt-2">
                    <List items={packing.essentials} />
                  </div>
                </div>
                <div>
                  <div className="text-sm font-semibold">小孩</div>
                  <div className="mt-2">
                    <List items={packing.kid} />
                  </div>
                </div>
                <div>
                  <div className="text-sm font-semibold">天氣/穿搭</div>
                  <div className="mt-2">
                    <List items={packing.weather} />
                  </div>
                </div>
              </div>
            </SectionCard>

            <SectionCard title="預算小表" icon={Wallet}>
              <div className="space-y-3">
                {budgetTemplate.map((row) => (
                  <div key={row.k} className="grid grid-cols-[1fr,140px] items-center gap-3">
                    <div>
                      <div className="text-sm font-semibold">{row.k}</div>
                      <div className="text-xs text-slate-500">{row.hint}</div>
                    </div>
                    <input
                      inputMode="numeric"
                      value={budget[row.k]}
                      onChange={(e) =>
                        setBudget((prev) => ({
                          ...prev,
                          [row.k]: e.target.value.replace(/[^0-9]/g, ""),
                        }))
                      }
                      placeholder="0"
                      className="w-full rounded-2xl border px-4 py-3 text-sm outline-none focus:ring-2"
                    />
                  </div>
                ))}
                <div className="rounded-2xl border bg-slate-50 p-4">
                  <div className="text-xs text-slate-500">總預算（可自行改幣別）</div>
                  <div className="mt-1 text-lg font-semibold">{cnMoney(budgetSum)}</div>
                </div>
              </div>
            </SectionCard>
          </div>

          {/* Main */}
          <div className="space-y-6">
            <SectionCard
              title={`${activeDay.date}｜${activeDay.city}`}
              icon={MapPin}
              right={
                <span className="rounded-2xl border bg-white px-3 py-1 text-xs text-slate-600 shadow-sm">
                  {activeDay.theme}
                </span>
              }
            >
              <div className="grid gap-4">
                <AnimatePresence mode="wait">
                  <motion.div
                    key={activeDay.id}
                    initial={{ opacity: 0, y: 8 }}
                    animate={{ opacity: 1, y: 0 }}
                    exit={{ opacity: 0, y: -8 }}
                    transition={{ duration: 0.2 }}
                    className="grid gap-4"
                  >
                    {activeDay.blocks.map((b, i) => (
                      <DayBlock key={i} b={b} />
                    ))}
                  </motion.div>
                </AnimatePresence>
              </div>

              <div className="mt-6 grid gap-4 md:grid-cols-2">
                <div className="rounded-2xl border bg-white p-4 shadow-sm">
                  <div className="flex items-center gap-2">
                    <Baby className="h-5 w-5" />
                    <div className="text-sm font-semibold">親子小提醒</div>
                  </div>
                  <div className="mt-3">
                    <List items={activeDay.kidTips || []} />
                  </div>
                </div>

                <div className="rounded-2xl border bg-white p-4 shadow-sm">
                  <div className="flex items-center gap-2">
                    <ClipboardList className="h-5 w-5" />
                    <div className="text-sm font-semibold">當日待辦（可勾選）</div>
                  </div>
                  <div className="mt-3 space-y-2">
                    {(activeDay.checklist || []).map((item) => {
                      const checked = done?.[activeDay.id]?.[item] ?? false;
                      return (
                        <button
                          key={item}
                          onClick={() => toggleChecklist(activeDay.id, item)}
                          type="button"
                          className={classNames(
                            "flex w-full items-start gap-3 rounded-2xl border p-3 text-left text-sm transition",
                            checked ? "bg-slate-50" : "bg-white hover:shadow-sm"
                          )}
                        >
                          <div
                            className={classNames(
                              "mt-0.5 h-5 w-5 rounded-lg border",
                              checked ? "bg-black" : "bg-white"
                            )}
                          />
                          <div>
                            <div className={classNames("font-medium", checked ? "line-through opacity-60" : "")}
                            >
                              {item}
                            </div>
                          </div>
                        </button>
                      );
                    })}
                  </div>
                </div>
              </div>
            </SectionCard>

            <SectionCard title="備案模組（遇到天氣/狀態不佳時）" icon={CloudRain}>
              <div className="grid gap-4 md:grid-cols-3">
                <div className="rounded-2xl border bg-white p-4 shadow-sm">
                  <div className="text-sm font-semibold">室內方案</div>
                  <div className="mt-2 text-sm text-slate-700 leading-relaxed">
                    商場＋美食街＋遊戲區，一次解決吃飯、上廁所、放電。
                  </div>
                </div>
                <div className="rounded-2xl border bg-white p-4 shadow-sm">
                  <div className="text-sm font-semibold">微縮行程</div>
                  <div className="mt-2 text-sm text-slate-700 leading-relaxed">
                    把一天拆成兩段：上午 1 個點、下午回房間休息，晚上附近走走。
                  </div>
                </div>
                <div className="rounded-2xl border bg-white p-4 shadow-sm">
                  <div className="text-sm font-semibold">交通友善</div>
                  <div className="mt-2 text-sm text-slate-700 leading-relaxed">
                    優先選：地鐵一站到、或計程車 15 分鐘內；減少換乘次數。
                  </div>
                </div>
              </div>
            </SectionCard>

            <div className="text-xs text-slate-500">
              提示：這個行程是『親子節奏』的預設模板。你可以直接改 itinerary 陣列，把餐廳、住宿、交通站名補齊，就會變成更完整的專屬 APP。
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
